services:
  # ------------------------------------
  # 1. User Authentication Service
  # ------------------------------------
  - type: web
    name: user-authentication
    env: docker
    dockerfilePath: ./microservices/user-authentication/Dockerfile
    dockerContext: ./microservices/user-authentication
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        sync: false # À définir dans le dashboard Render (MongoDB Atlas)
      - key: JWT_SECRET
        generateValue: true

  # ------------------------------------
  # 2. User Preferences Service
  # ------------------------------------
  - type: web
    name: user-preferences
    env: docker
    dockerfilePath: ./microservices/user-preferences/Dockerfile
    dockerContext: ./microservices/user-preferences
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        sync: false

  # ------------------------------------
  # 3. Content Feed Service
  # ------------------------------------
  - type: web
    name: content-feed
    env: docker
    dockerfilePath: ./microservices/content-feed/Dockerfile
    dockerContext: ./microservices/content-feed
    envVars:
      - key: NODE_ENV
        value: production
      # Liaison avec Redis (défini plus bas)
      - key: REDIS_URL
        fromService:
          type: redis
          name: content-cache
          property: connectionString
      - key: GNEWS_API_KEY
        sync: false
      - key: AFRICA_NEWS_API_KEY
        sync: false

  # ------------------------------------
  # 4. Content Recommendation Service
  # ------------------------------------
  - type: web
    name: content-recommendation
    env: docker
    dockerfilePath: ./microservices/content-recommendation/Dockerfile
    dockerContext: ./microservices/content-recommendation
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        sync: false

  # ------------------------------------
  # 5. Content Categories Service
  # ------------------------------------
  - type: web
    name: content-categories
    env: docker
    dockerfilePath: ./microservices/content-categories/Dockerfile
    dockerContext: ./microservices/content-categories
    envVars:
      - key: NODE_ENV
        value: production
      - key: DATABASE_URL
        sync: false

  # ------------------------------------
  # 6. API Gateway (Le point d'entrée)
  # ------------------------------------
  - type: web
    name: api-gateway
    env: docker
    plan: free 
    dockerfilePath: ./microservices/api-gateway/Dockerfile
    dockerContext: ./microservices/api-gateway
    envVars:
      - key: NODE_ENV
        value: production
      # Injection automatique des URLs des autres services
      - key: AUTH_SERVICE_URL
        fromService:
          name: user-authentication
          type: web
          property: url
      - key: PREFERENCES_SERVICE_URL
        fromService:
          name: user-preferences
          type: web
          property: url
      - key: FEED_SERVICE_URL
        fromService:
          name: content-feed
          type: web
          property: url
      - key: RECOMMENDATION_SERVICE_URL
        fromService:
          name: content-recommendation
          type: web
          property: url
      - key: CATEGORIES_SERVICE_URL
        fromService:
          name: content-categories
          type: web
          property: url

# ------------------------------------
# Base de données Redis (Gérée par Render)
# ------------------------------------
databases:
  - name: content-cache
    plan: free # Gratuit pour commencer
    ipAllowList: [] # Accessible uniquement par vos services internes
