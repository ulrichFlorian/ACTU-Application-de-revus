services:
  # ------------------------------------
  # 1. User Authentication Service
  # ------------------------------------
  - type: web
    name: user-authentication
    env: docker
    dockerfilePath: ./microservices/user-authentication/Dockerfile
    dockerContext: ./microservices/user-authentication
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3004
      - key: DATABASE_URL
        sync: false
      - key: JWT_SECRET
        generateValue: true

  # ------------------------------------
  # 2. User Preferences Service
  # ------------------------------------
  - type: web
    name: user-preferences
    env: docker
    dockerfilePath: ./microservices/user-preferences/Dockerfile
    dockerContext: ./microservices/user-preferences
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3001
      - key: DATABASE_URL
        sync: false

  # ------------------------------------
  # 3. Content Feed Service
  # ------------------------------------
  - type: web
    name: content-feed
    env: docker
    dockerfilePath: ./microservices/content-feed/Dockerfile
    dockerContext: ./microservices/content-feed
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3002
      # Liaison avec Redis
      - key: REDIS_URL
        fromService:
          type: redis
          name: content-cache
          property: connectionString
      - key: GNEWS_API_KEY
        sync: false
      - key: AFRICA_NEWS_API_KEY
        sync: false

  # ------------------------------------
  # 4. Content Recommendation Service
  # ------------------------------------
  - type: web
    name: content-recommendation
    env: docker
    dockerfilePath: ./microservices/content-recommendation/Dockerfile
    dockerContext: ./microservices/content-recommendation
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3003
      - key: DATABASE_URL
        sync: false

  # ------------------------------------
  # 5. Content Categories Service
  # ------------------------------------
  - type: web
    name: content-categories
    env: docker
    dockerfilePath: ./microservices/content-categories/Dockerfile
    dockerContext: ./microservices/content-categories
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3005
      - key: DATABASE_URL
        sync: false

  # ------------------------------------
  # 6. API Gateway (Le point d'entrée)
  # ------------------------------------
  - type: web
    name: api-gateway
    env: docker
    plan: free 
    dockerfilePath: ./microservices/api-gateway/Dockerfile
    dockerContext: ./microservices/api-gateway
    envVars:
      - key: NODE_ENV
        value: production
      - key: PORT
        value: 3000
      
      # -----------------------------------------------------------
      # CORRECTION MAJEURE ICI :
      # On utilise les URLs internes explicites au lieu de fromService
      # Format: http://<nom-du-service>:<port>
      # -----------------------------------------------------------
      - key: AUTH_SERVICE_URL
        value: http://user-authentication:3004
      - key: PREFERENCES_SERVICE_URL
        value: http://user-preferences:3001
      - key: FEED_SERVICE_URL
        value: http://content-feed:3002
      - key: RECOMMENDATION_SERVICE_URL
        value: http://content-recommendation:3003
      - key: CATEGORIES_SERVICE_URL
        value: http://content-categories:3005

# ------------------------------------
# Base de données Redis (Gérée par Render)
# ------------------------------------
databases:
  - name: content-cache
    plan: free
    ipAllowList: []
